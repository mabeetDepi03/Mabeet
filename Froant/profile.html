<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mabeet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="css/styles.css">
    
    <style>
        /* CSS Ø§Ù„Ø®Ø§Øµ Ø¨ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ */
        body { background-color: #f4f7f6; font-family: 'Cairo', sans-serif; }
        .user-bg { background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-blue) 100%); height: 150px; }
        .profile-header-card {
            background: var(--white);
            border-radius: 20px;
            padding: 30px;
            margin-top: -60px;
            position: relative;
            z-index: 10;
            box-shadow: var(--shadow-hover);
        }
        .profile-pic { width: 100px; height: 100px; object-fit: cover; border-radius: 50%; border: 4px solid white; margin-bottom: 15px; }
        .booking-card { 
            border: 1px solid #e0e0e0; 
            border-radius: 10px; 
            margin-bottom: 20px; 
            transition: all 0.3s ease;
        }
        .booking-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .booking-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 10px 10px 0 0;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
        }
        .status-Pending { background-color: #fff3cd; color: #ffc107; border: 1px solid #ffc107; }
        .status-Confirmed { background-color: #d1e7dd; color: #198754; border: 1px solid #198754; }
        .status-Cancelled { background-color: #f8d7da; color: #dc3545; border: 1px solid #dc3545; }

    </style>
</head>
<body class="d-flex flex-column min-vh-100">

    <div id="navbar-placeholder"></div>

    <main class="flex-grow-1">
        <div class="user-bg"></div>

        <div class="container">
            <div class="profile-header-card text-center mb-5">
                <img src="https://placehold.co/100x100?text=User" alt="Profile Picture" class="profile-pic">
                <h3 id="userName" class="fw-bold text-dark">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
                <p id="userEmail" class="text-muted"></p>
                <button onclick="ApiService.logout()" class="btn btn-outline-danger btn-sm mt-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>

            <h2 class="text-center mb-4 fw-bold" style="color: var(--primary-color);">Ø­Ø¬ÙˆØ²Ø§ØªÙŠ</h2>
            <div class="row" id="bookings-container">
                <div class="col-12 text-center py-5" id="loading-spinner">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª...</p>
                </div>
            </div>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="./js/api-config.js"></script>
    <script src="./js/auth.js"></script>
    <script src="./js/components.js"></script>

    <script>
        AOS.init();
        
        // â­ï¸ Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù…Ø¤Ù‚ØªØ§Ù‹
        let allBookingsData = []; 

        // ğŸš¨ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        if (!ApiService.getToken()) {
            window.location.href = 'login.html';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            loadBookings();
            loadUserInfo();
        });

        // ----------------------------------------------------
        // ğŸŸ¢ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ®Ø²Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø² ÙÙŠ localStorage Ø«Ù… ØªÙˆØ¬Ù‡ Ù„Ù„Ø¯ÙØ¹
        // ----------------------------------------------------
        window.storeAndRedirectForPayment = function(bookingId) {
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø² ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø©
            const selectedBooking = allBookingsData.find(b => b.bookingID === bookingId);
            
            if (selectedBooking) {
                console.log(`ğŸš€ [localStorage] Ø¬Ø§Ø±ÙŠ ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø² Ø±Ù‚Ù…: ${bookingId}`);
                // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ø­Ø¬Ø² ÙÙŠ localStorage Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙØªØ§Ø­ ÙØ±ÙŠØ¯
                localStorage.setItem(`paymentBookingData_${bookingId}`, JSON.stringify(selectedBooking));
                
                // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹ Ù…Ø¹ ØªØ¶Ù…ÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„Ø­Ø¬Ø² ÙÙŠ Ø§Ù„Ù€ URL
                window.location.href = `pay.html?bookingId=${bookingId}`;
            } else {
                Swal.fire('Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø² Ù„ØªØ®Ø²ÙŠÙ†Ù‡Ø§. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.', 'error');
            }
        }
        
        async function loadUserInfo() {
            // ÙŠØªÙ… ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙÙŠ localStorage Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            const user = JSON.parse(localStorage.getItem('userData'));
            if (user) {
                document.getElementById('userName').innerText = user.firstName || 'Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                document.getElementById('userEmail').innerText = user.email || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ';
            }
        }

async function loadBookings() {
    const container = document.getElementById('bookings-container');
    const spinner = document.getElementById('loading-spinner');
    if(spinner) spinner.style.display = 'block';
    container.innerHTML = ''; 

    try {
        const token = ApiService.getToken();
        const userId = JSON.parse(localStorage.getItem('userData')).id;
        console.log(userId);
        
        if (!userId || !token) {
            throw new Error("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙÙ‚ÙˆØ¯Ø©");
        }
        
        const response = await fetch(`${API_BASE_URL}/Bookings/user/${userId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        console.log(response)
        if (!response.ok) {
            // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„Ù€ Response Ù„Ù‚Ø±Ø§Ø¡Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
            const responseClone = response.clone();
            let errorMessage = "ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±.";
            
            try {
                const errorData = await responseClone.json();
                errorMessage = errorData.message || errorMessage;
            } catch (e) {
                // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª JSONØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Øµ Ø§Ù„Ù€ Response
                const textError = await responseClone.text();
                if (textError) errorMessage = textError;
            }
            
            throw new Error(errorMessage);
        }

        const bookings = await response.json();

        // â­ï¸ ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ
        allBookingsData = bookings; 

        if(spinner) spinner.style.display = 'none';

        if (bookings.length === 0) {
            container.innerHTML = '<div class="col-12 alert alert-info text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>';
            return;
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª
        bookings.forEach(b => {
            const statusClass = `status-${b.status}`;
            const statusText = b.status === 'Pending' ? 'Ù…Ø¹Ù„Ù‚' : 
                              b.status === 'Confirmed' ? 'Ù…Ø¤ÙƒØ¯' : 
                              'Ù…Ù„ØºÙ‰';
            const paymentStatusText = b.paymentStatus === 'Pending' ? 'Ø§Ù„Ø¯ÙØ¹ Ù…Ø¹Ù„Ù‚' : 'ØªÙ… Ø§Ù„Ø¯ÙØ¹';
            
            const card = `
                <div class="col-md-6">
                    <div class="booking-card bg-white p-3">
                        <img src="${ApiService.getImageUrl(b.imagePath)}" class="booking-image" 
                             alt="${b.accommodationName || 'Ø­Ø¬Ø²'}" 
                             onerror="this.src='https://placehold.co/600x150?text=Mabeet'">
                        <div class="card-body p-0 pt-3">
                            <h5 class="fw-bold">${b.accommodationName || 'ÙˆØ­Ø¯Ø© Ø³ÙƒÙ†ÙŠØ©'}</h5>
                            <p class="text-muted small mb-1">
                                <i class="fas fa-calendar-alt text-primary me-1"></i> ${new Date(b.checkIN).toLocaleDateString()} Ø¥Ù„Ù‰ ${new Date(b.checkOUT).toLocaleDateString()}
                            </p>
                            <p class="text-muted small mb-3">
                                <i class="fas fa-map-marker-alt text-secondary me-1"></i> ${b.locationName}
                            </p>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                            <div>
                                <span class="status-badge ${statusClass} me-2">${statusText}</span>
                                <span class="status-badge ${b.paymentStatus === 'Pending' ? 'status-Pending' : 'status-Confirmed'}">${paymentStatusText}</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="fw-bold me-3">${b.totalPrice} Ø¬.Ù…</span>
                                
                                ${b.paymentStatus === 'Pending' ? 
                                    `<button onclick="storeAndRedirectForPayment(${b.bookingID})" class="btn btn-sm btn-primary me-2">Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†</button>` 
                                    : ''}

                                ${b.status === 'Pending' ? 
                                    `<button onclick="cancelBooking(${b.bookingID})" class="btn btn-sm btn-outline-danger">Ø¥Ù„ØºØ§Ø¡</button>` 
                                    : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += card;
        });

    } catch (e) {
        console.log("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª:", e);
        if(spinner) spinner.style.display = 'none';
        container.innerHTML = `
            <div class="col-12 alert alert-danger text-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª: ${e.message}
            </div>
        `;
    }
}
        async function cancelBooking(id) {
            if(await Swal.fire({title:'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ', text:'Ø³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø².', icon:'warning', showCancelButton:true}).then(r => r.isConfirmed)){
                try {
                    const res = await fetch(`${API_BASE_URL}/Bookings/${id}/cancel`, {
                        method: 'PUT',
                        headers: { 'Authorization': `Bearer ${ApiService.getToken()}` }
                    });
                    if(res.ok) {
                        Swal.fire('ØªÙ…', 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø²', 'success').then(() => location.reload());
                    } else { 
                        const err = await res.json();
                        throw new Error(err.message || 'ÙØ´Ù„ Ø§Ù„Ø¥Ù„ØºØ§Ø¡'); 
                    }
                } catch(e) { Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø¥Ù„ØºØ§Ø¡: ' + e.message, 'error'); }
            }
        }
    </script>
</body>
</html>